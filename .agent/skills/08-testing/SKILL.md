---
name: testing
description: DRN.Framework.Testing - DrnTestContext, ContainerContext, WebApplicationContext, DataAttributes, and test providers
---

# DRN.Framework.Testing

> Comprehensive testing infrastructure enabling DTT (Duran's Testing Technique).

## When to Apply
- Setting up test projects
- Writing unit tests with auto-mocking
- Writing integration tests with testcontainers
- Working with WebApplicationFactory
- Using data attributes and providers

---

## Package Purpose

DRN.Framework.Testing makes testing **easy and encouraging** by providing:
- Auto-mocking via NSubstitute
- Auto-fixture data generation
- PostgreSQL testcontainers
- WebApplicationFactory integration
- Convention-based settings/data loading

---

## Directory Structure

```
DRN.Framework.Testing/
├── Contexts/        # DrnTestContext, ContainerContext, WebApplicationContext
├── DataAttributes/  # DataInline, DataMember, DataSelf
├── TestAttributes/  # FactDebuggerOnly, TheoryDebuggerOnly
├── Providers/       # SettingsProvider, DataProvider
├── Extensions/      # Test extensions
└── Usings.cs
```

---

## DrnTestContext

## DrnTestContext

Core test context providing service collection and provider.

### Context Augmentations

`DrnTestContext` augments the test environment by:
- **Auto-Registration**: Automatically calls `AddDrnUtils()` (logging, settings, etc.).
- **Startup Jobs**: Triggers `StartupJobRunner` to handle one-time setups (e.g., Auth tokens, global config) defined via `[StartupJob]`.
- **Method Context**: Captures test method metadata for folder-based settings resolution.

```csharp
[Theory]
[DataInline]
public void MyTest(DrnTestContext context, IMockable mock)
{
    context.ServiceCollection.AddMyServices();
    mock.DoSomething().Returns(42);
    
    var service = context.GetRequiredService<MyService>();
    service.Execute().Should().Be(42);
}
```

### Key Properties

| Property | Purpose |
|----------|---------|
| `ServiceCollection` | Add services before building |
| `ContainerContext` | PostgreSQL testcontainer management |
| `ApplicationContext` | Full application context |
| `FlurlHttpTest` | HTTP mocking for external calls |
| `Configuration` | Test configuration |

### Key Methods

| Method | Purpose |
|--------|---------|
| `GetRequiredService<T>()` | Resolve service (builds provider if needed) |
| `BuildServiceProvider()` | Explicitly build provider |
| `ValidateServicesAsync()` | Validate attribute-based services |
| `GetData(path)` | Get test data file content |
| `AddToConfiguration(object)` | Add configuration before service resolution |
| `CreateScope()` | Create new DI scope for concurrent contexts |

---

## ContainerContext

Testcontainer management for integration tests:

```csharp
[Theory]
[DataInline]
public async Task DbTest(DrnTestContext context)
{
    context.ServiceCollection.AddInfraServices();
    await context.ContainerContext.Postgres.ApplyMigrationsAsync();
    
    var dbContext = context.GetRequiredService<QAContext>();
    dbContext.Users.Add(new User("test"));
    await dbContext.SaveChangesAsync();
}
```

### Features
- Auto-creates PostgreSQL container
- Scans service collection for DrnContexts
- Adds connection strings automatically
- Applies migrations

---

## ApplicationContext

WebApplicationFactory wrapper for API testing:

```csharp
[Theory]
[DataInline]
public async Task ApiTest(DrnTestContext context, ITestOutputHelper outputHelper)
{
    // CreateClientAsync starts app, applies migrations, returns authenticated client
    var client = await context.ApplicationContext.CreateClientAsync<SampleProgram>(outputHelper);
    
    var endpoint = Get.Endpoint.Sample.WeatherForecast.Get.RoutePattern;
    var forecasts = await client.GetFromJsonAsync<WeatherForecast[]>(endpoint);
    forecasts.Should().NotBeEmpty();
}
```

### Key Methods

| Method | Purpose |
|--------|---------|
| `CreateClientAsync<TProgram>(outputHelper)` | Create authenticated HTTP client |
| `CreateApplicationAndBindDependenciesAsync<TProgram>()` | Bind dependencies without HTTP client |
| `LogToTestOutput(outputHelper)` | Direct logs to test output |

### Features
- Syncs DrnTestContext with WebApplicationFactory
- Provides configuration to Program
- Shares service provider
- Automatic PostgreSQL container startup and migrations

---

## Data Attributes

### DataInline

```csharp
[Theory]
[DataInline(99, "test")]
public void Test(DrnTestContext context, int value, string name, Guid autoGenerated)
{
    // value = 99 (inlined)
    // name = "test" (inlined)
    // autoGenerated = auto-fixture Guid
}
```

### DataMember

```csharp
[Theory]
[DataMember(nameof(TestData))]
public void Test(DrnTestContext context, int value, ComplexType obj)
{
    // Data from TestData property
}

public static IEnumerable<object[]> TestData => new List<object[]>
{
    new object[] { 1, new ComplexType() },
    new object[] { 2, new ComplexType() }
};
```

### DataSelf

```csharp
public class MyTestData : DataSelfAttribute
{
    public MyTestData()
    {
        AddRow(1, "first");
        AddRow(2, "second");
    }
}

[Theory]
[MyTestData]
public void Test(DrnTestContext context, int id, string name) { }
```

---

## Test Attributes

| Attribute | Purpose |
|-----------|---------|
| `[FactDebuggerOnly]` | Run only when debugger attached |
| `[TheoryDebuggerOnly]` | Theory only when debugger attached |

Useful for tests requiring real databases or external dependencies.

---

## Providers

### SettingsProvider

```csharp
var appSettings = SettingsProvider.GetAppSettings();
var config = SettingsProvider.GetConfiguration("mySettings");
```

Settings loaded from `Settings/` folder or test file folder.

### DataProvider

```csharp
var content = DataProvider.Get("test-data.json");
```

Data loaded from `Data/` folder or test file folder.

---

## Auto-Mocking

Interfaces in test parameters are auto-mocked with NSubstitute:

```csharp
[Theory]
[DataInline]
public void Test(DrnTestContext context, IMyService mock)
{
    mock.GetValue().Returns(42);  // NSubstitute mock
    
    context.ServiceCollection.AddScoped<IMyService>(_ => mock);
    // Or context automatically replaces actual service with mock
}
```

---

## Global Usings

```csharp
global using Xunit;
global using AutoFixture;
global using AutoFixture.AutoNSubstitute;
global using DRN.Framework.Testing;
global using DRN.Framework.Testing.DataAttributes;
global using DRN.Framework.Testing.Providers;
global using DRN.Framework.Testing.TestAttributes;
global using DRN.Framework.Testing.Contexts;
global using AwesomeAssertions;
global using NSubstitute;
```

---

## Test Project Setup

```xml
<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <IsPackable>false</IsPackable>
        <IsTestProject>true</IsTestProject>
    </PropertyGroup>
    
    <ItemGroup>
        <PackageReference Include="DRN.Framework.Testing" />
    </ItemGroup>
    
    <ItemGroup>
        <None Update="Settings\appsettings.json">
            <CopyToOutputDirectory>Always</CopyToOutputDirectory>
        </None>
        <None Update="Data\*.txt">
            <CopyToOutputDirectory>Always</CopyToOutputDirectory>
        </None>
    </ItemGroup>
</Project>
```

---

## Related Skills

- [03-drn-testing-overview.md](file:///Users/duranserkankilic/Work/Drn-Project/.agent/skills/03-drn-testing-overview.md) - Testing philosophy
- [05-utils.md](file:///Users/duranserkankilic/Work/Drn-Project/.agent/skills/05-utils.md) - DI and settings
- [07-entityframework.md](file:///Users/duranserkankilic/Work/Drn-Project/.agent/skills/07-entityframework.md) - Database testing
- [09-test-unit.md](file:///Users/duranserkankilic/Work/Drn-Project/.agent/skills/09-test-unit.md) - Unit test patterns
- [10-test-integration.md](file:///Users/duranserkankilic/Work/Drn-Project/.agent/skills/10-test-integration.md) - Integration patterns
- [11-test-performance.md](file:///Users/duranserkankilic/Work/Drn-Project/.agent/skills/11-test-performance.md) - Performance testing

---
